<article class="space-y-6">
  <div
    class="flex flex-col md:flex-row md:items-center md:justify-between gap-4"
  >
    <h2 class="text-3xl font-semibold">Mood Analytics</h2>
    <div class="flex items-center gap-2">
      <select
        class="select select-bordered"
        [ngModel]="selectedRange()"
        (ngModelChange)="updateRange($event)"
        [disabled]="analyticsResource.isLoading()"
      >
        @for (range of ranges(); track range) {
          <option [value]="range">{{ range }}</option>
        }
      </select>
      <button class="btn btn-outline btn-sm" (click)="export()" [disabled]="analyticsResource.isLoading()">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          class="h-5 w-5 mr-1"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M4 16v0a2 2 0 002 2h12a2 2 0 002-2v0M7 10l5 5m0 0l5-5m-5 5V4"
          />
        </svg>
        Export
      </button>
    </div>
  </div>

  @if (analyticsResource.isLoading()) {
    <div class="flex justify-center items-center p-12">
      <span class="loading loading-spinner loading-lg text-primary"></span>
    </div>
  } @else if (analyticsResource.error()) {
    <div class="alert alert-error">
      <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
      <span>Error al cargar los datos. Por favor, inténtalo de nuevo.</span>
      <button class="btn btn-sm" (click)="analyticsResource.reload()">Reintentar</button>
    </div>
  } @else {
    <div
      class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-6"
    >
      @for (mood of moods(); track mood.label) {
        <div
          class="card bg-base-100 shadow-lg rounded-lg p-6 border-t-4"
          [style.border-color]="mood.color"
        >
          <span class="text-lg font-medium text-gray-600">{{ mood.label }}</span>
          <h3 class="text-4xl font-bold mt-2">{{ mood.percent }}%</h3>
          <p class="text-sm text-gray-500 mt-1">
            {{ mood.entries | number }} entries
            <span
              [ngClass]="{
                'text-success': mood.delta >= 0,
                'text-error': mood.delta < 0,
              }"
            >
              @if (mood.delta !== 0) {
                • {{ mood.delta >= 0 ? "+" : "" }}{{ mood.delta }}%
              }
            </span>
          </p>
        </div>
      } @empty {
        <div class="col-span-full text-center py-8">
          <div class="text-gray-400">No mood data available</div>
        </div>
      }
    </div>

    <div class="tabs tabs-boxed">
      @for (tab of tabs(); track tab) {
        <a
          class="tab"
          [class.tab-active]="activeTab() === tab"
          (click)="setActiveTab(tab)"
        >
          {{ tab }}
        </a>
      }
    </div>

    <section class="p-4 bg-base-200 rounded-lg min-h-48">
      @switch (activeTab()) {
        @case (tabs()[0]) {
          <div class="flex flex-col items-center">
            <h3 class="text-xl font-semibold mb-4">Mood Heatmap</h3>
            <div class="grid grid-cols-7 gap-1 w-full max-w-lg">
              @for (day of daysArray(); track day) {
                <div
                  class="w-full aspect-square rounded-sm"
                  [style.background-color]="getDayColor(day)"
                ></div>
              }
            </div>
            <div class="text-xs text-gray-500 mt-2">
              Last 5 weeks mood tracking
            </div>
          </div>
        }
        @case (tabs()[1]) {
          <div class="flex flex-col items-center">
            <h3 class="text-xl font-semibold mb-4">Mood Distribution</h3>
            <div class="flex w-full max-w-xl h-48 items-end gap-2">
              @for (mood of moods(); track mood.label) {
                <div
                  class="flex-1 bg-opacity-80 rounded-t-lg"
                  [style.background-color]="mood.color"
                  [style.height.%]="mood.percent"
                >
                  <div class="h-full flex flex-col justify-between p-2">
                    <span class="text-xs font-bold text-white"
                      >{{ mood.percent }}%</span
                    >
                    <span class="text-xs font-semibold text-white">{{
                      mood.label
                    }}</span>
                  </div>
                </div>
              } @empty {
                <div class="w-full text-center py-12 text-gray-400">
                  No mood distribution data available
                </div>
              }
            </div>
          </div>
        }
        @case (tabs()[2]) {
          <div class="flex flex-col items-center">
            <h3 class="text-xl font-semibold mb-4">Mood Trends</h3>
            @if (moods().length > 0) {
              <div class="w-full max-w-xl h-60 relative">
                <svg viewBox="0 0 100 30" class="w-full h-full">
                  <!-- Líneas de tendencia simuladas para cada estado de ánimo -->
                  @for (mood of moods(); track mood.label; let i = $index) {
                    <polyline
                      [attr.points]="
                        '0,30 20,' +
                        (30 - mood.percent * 0.5) +
                        ' 40,' +
                        (30 - (mood.percent + mood.delta) * 0.5) +
                        ' 60,' +
                        (30 - (mood.percent + mood.delta * 0.5) * 0.5) +
                        ' 80,' +
                        (30 - (mood.percent + mood.delta * 2) * 0.5) +
                        ' 100,' +
                        (30 - (mood.percent + mood.delta * 2.5) * 0.5)
                      "
                      [style.stroke]="mood.color"
                      stroke-width="1.5"
                      fill="none"
                    />
                  }
                </svg>
                <div class="flex justify-between text-xs text-gray-500 mt-1">
                  <span>5 weeks ago</span>
                  <span>4 weeks ago</span>
                  <span>3 weeks ago</span>
                  <span>2 weeks ago</span>
                  <span>1 week ago</span>
                  <span>Now</span>
                </div>
              </div>
              <div class="flex flex-wrap gap-4 mt-4 justify-center">
                @for (mood of moods(); track mood.label) {
                  <div class="flex items-center gap-1">
                    <span
                      class="w-3 h-3 rounded-full"
                      [style.background-color]="mood.color"
                    ></span>
                    <span class="text-xs">{{ mood.label }}</span>
                  </div>
                }
              </div>
            } @else {
              <div class="text-center py-12 text-gray-400">
                No mood trend data available
              </div>
            }
          </div>
        }
        @default {
          <p class="text-center text-gray-500">Please select a tab</p>
        }
      }
    </section>
  }
</article>
