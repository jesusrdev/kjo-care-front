<div class="space-y-6">
  <!-- Título y controles -->
  <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
    <h3 class="text-xl font-semibold flex items-center">
      <i class="material-icons mr-2 text-primary">show_chart</i>
      Mood Trends
    </h3>
    <div class="flex items-center gap-2">
      <div class="relative">
        <i class="material-icons absolute left-3 top-2.5 opacity-60">date_range</i>
        <select
          class="select select-bordered select-sm pl-10"
          [ngModel]="selectedTimeRange()"
          (ngModelChange)="updateTimeRange($event)"
          [disabled]="loading()"
        >
          @for (range of timeRangeOptions(); track range) {
            <option [value]="range">{{ range }}</option>
          }
        </select>
      </div>
    </div>
  </div>

  @if (loading() || analyticsResource.isLoading()) {
    <div class="flex justify-center items-center h-64">
      <span class="loading loading-spinner loading-lg text-primary"></span>
    </div>
  } @else if (analyticsResource.error()) {
    <div class="alert alert-error">
      <i class="material-icons stroke-current shrink-0">error_outline</i>
      <span>Error loading mood trends. Please try again.</span>
      <button class="btn btn-sm" (click)="analyticsResource.reload()">
        <i class="material-icons text-sm mr-1">refresh</i>
        Retry
      </button>
    </div>
  } @else {
    <!-- Dashboard cards con KPIs -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <div class="card bg-base-100 shadow-sm">
        <div class="card-body p-4">
          <h3 class="text-sm font-normal text-gray-500">Overall Trend</h3>
          <div class="flex items-center gap-2 mt-1">
            <div class="flex items-center gap-1 text-lg font-semibold" [class]="getTrendText(overallTrend())">
              <i class="material-icons">{{ getTrendIcon(overallTrend()) }}</i>
              <span>{{ overallTrend() === 'up' ? 'Improving' : overallTrend() === 'down' ? 'Declining' : 'Stable' }}</span>
            </div>
          </div>
          <p class="text-xs text-gray-500 mt-1">Based on your mood patterns over time</p>
        </div>
      </div>

      <div class="card bg-base-100 shadow-sm">
        <div class="card-body p-4">
          <h3 class="text-sm font-normal text-gray-500">Positivity Rate</h3>
          <div class="flex items-center justify-between mt-1">
            <div class="text-lg font-semibold" [class]="positivityRate() >= 50 ? 'text-success' : positivityRate() >= 30 ? 'text-warning' : 'text-error'">
              {{ positivityRate() }}%
            </div>
            <div class="radial-progress" [style.--value]="positivityRate()" [style.--size]="'3rem'" [style.--thickness]="'3px'" [style.color]="positivityRate() >= 50 ? '#68D391' : positivityRate() >= 30 ? '#FBD38D' : '#F56565'">
              <i class="material-icons text-sm">{{ positivityRate() >= 50 ? 'sentiment_very_satisfied' : positivityRate() >= 30 ? 'sentiment_neutral' : 'sentiment_dissatisfied' }}</i>
            </div>
          </div>
          <p class="text-xs text-gray-500 mt-1">Percentage of days with positive moods</p>
        </div>
      </div>

      <div class="card bg-base-100 shadow-sm">
        <div class="card-body p-4">
          <h3 class="text-sm font-normal text-gray-500">Mood Variability</h3>
          <div class="flex items-center justify-between mt-1">
            <div class="text-lg font-semibold" [class]="moodVariability() <= 30 ? 'text-success' : moodVariability() <= 60 ? 'text-warning' : 'text-error'">
              {{ moodVariability() }}%
            </div>
            <div class="w-10 h-10 flex items-center justify-center rounded-full bg-base-200">
              <i class="material-icons" [class]="moodVariability() <= 30 ? 'text-success' : moodVariability() <= 60 ? 'text-warning' : 'text-error'">
                {{ moodVariability() <= 30 ? 'waves' : moodVariability() <= 60 ? 'water' : 'tsunami' }}
              </i>
            </div>
          </div>
          <p class="text-xs text-gray-500 mt-1">How often your mood changes significantly</p>
        </div>
      </div>
    </div>

    <!-- Gráfico principal de tendencias -->
    <div class="card bg-base-100 shadow-sm">
      <div class="card-body">
        <h3 class="card-title text-base font-medium flex items-center mb-4">
          <i class="material-icons text-primary mr-2">insights</i>
          Mood Patterns Over Time
        </h3>

        <div class="h-64 relative">
          <!-- Eje Y (escala) -->
          <div class="absolute left-0 top-0 bottom-0 w-10 flex flex-col justify-between items-end pr-2 text-xs text-gray-500">
            <span>High</span>
            <span>Medium</span>
            <span>Low</span>
          </div>

          <!-- Gráfico SVG -->
          <div class="ml-10 h-full relative">
            <!-- Líneas de referencia horizontales -->
            <div class="absolute top-0 left-0 right-0 h-px bg-base-200"></div>
            <div class="absolute top-1/3 left-0 right-0 h-px bg-base-200"></div>
            <div class="absolute top-2/3 left-0 right-0 h-px bg-base-200"></div>
            <div class="absolute bottom-0 left-0 right-0 h-px bg-base-200"></div>

            <!-- Gráficas de líneas -->
            <svg viewBox="0 0 100 100" class="w-full h-full" preserveAspectRatio="none">
              @for (trend of moodTrends(); track trend.label) {
                <!-- Área bajo la curva con baja opacidad -->
                <path
                  [attr.d]="generateArea(trend.points)"
                  [attr.fill]="trend.color"
                  fill-opacity="0.1"
                  class="transition-all duration-700"
                ></path>

                <!-- Línea de tendencia -->
                <path
                  [attr.d]="generatePath(trend.points)"
                  [attr.stroke]="trend.color"
                  stroke-width="2"
                  fill="none"
                  stroke-linejoin="round"
                  class="transition-all duration-700"
                ></path>

                <!-- Puntos de datos -->
                @for (point of normalizePoints(trend.points); track $index) {
                  @if ($index % 3 === 0 || $index === normalizePoints(trend.points).length - 1) {
                    <circle
                      [attr.cx]="$index * (100 / (trend.points.length - 1))"
                      [attr.cy]="100 - point"
                      r="2"
                      [attr.fill]="trend.color"
                    ></circle>
                  }
                }
              }
            </svg>
          </div>

          <!-- Eje X (etiquetas de tiempo) -->
          <div class="ml-10 flex justify-between text-xs text-gray-500 mt-2">
            @for (label of getXAxisLabels(); track label) {
              <span>{{ label }}</span>
            }
          </div>
        </div>

        <!-- Leyenda -->
        <div class="flex flex-wrap gap-4 justify-center mt-4">
          @for (trend of moodTrends(); track trend.label) {
            <div class="flex items-center gap-1.5">
              <span class="w-3 h-3 rounded-full" [style.background-color]="trend.color"></span>
              <span class="text-sm">{{ trend.label }}</span>
            </div>
          }
        </div>
      </div>
    </div>

    <!-- Tarjetas de tendencia para cada estado de ánimo -->
    <h3 class="font-medium text-lg flex items-center mt-6 mb-3">
      <i class="material-icons mr-2 text-primary">mood</i>
      Individual Mood Trends
    </h3>

    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
      @for (trend of moodTrends(); track trend.label) {
        <div class="card bg-base-100 shadow-sm border-l-4 transition-all hover:shadow-md" [class]="getTrendColor(trend.trend)">
          <div class="card-body p-4">
            <div class="flex items-center justify-between mb-2">
              <div class="flex items-center gap-2">
                <div class="w-8 h-8 rounded-full flex items-center justify-center" [style.background-color]="trend.color">
                  <i class="material-icons text-white text-sm">{{ trend.icon }}</i>
                </div>
                <h4 class="font-medium">{{ trend.label }}</h4>
              </div>
              <div class="flex items-center gap-1" [class]="getTrendText(trend.trend)">
                <i class="material-icons text-sm">{{ getTrendIcon(trend.trend) }}</i>
                <span class="text-sm font-medium">
                  {{ trend.change >= 0 ? '+' : '' }}{{ trend.change }}%
                </span>
              </div>
            </div>

            <!-- Mini gráfico -->
            <div class="h-12 w-full">
              <svg viewBox="0 0 100 40" class="w-full h-full" preserveAspectRatio="none">
                <path
                  [attr.d]="generatePath(trend.points, 40)"
                  [attr.stroke]="trend.color"
                  stroke-width="2"
                  fill="none"
                  stroke-linejoin="round"
                  class="transition-all duration-700"
                ></path>

                <!-- Punto final -->
                <circle
                  cx="100"
                  [attr.cy]="40 - normalizePoints(trend.points, 40)[trend.points.length - 1]"
                  r="3"
                  [attr.fill]="trend.color"
                ></circle>
              </svg>
            </div>

            <!-- Interpretación según la tendencia -->
            <p class="text-xs text-gray-500 mt-2">
              @if (trend.trend === 'up') {
                This mood has been <span class="font-semibold text-success">increasing</span> over time.
              } @else if (trend.trend === 'down') {
                This mood has been <span class="font-semibold text-error">decreasing</span> over time.
              } @else {
                This mood has remained <span class="font-semibold">relatively stable</span>.
              }
            </p>
          </div>
        </div>
      }
    </div>

    <!-- Sección educativa -->
    <div class="card bg-base-100 shadow-sm mt-6">
      <div class="card-body p-5">
        <h4 class="card-title text-base font-medium flex items-center">
          <i class="material-icons mr-2 text-primary">psychology</i>
          Understanding Your Mood Trends
        </h4>
        <p class="text-gray-600 text-sm">
          This chart shows how your moods have changed over time. Understanding these patterns can help identify triggers and improve emotional well-being.
          Look for correlations between your activities, environment, or habits and changes in mood patterns.
        </p>

        <div class="mt-4">
          <h5 class="font-medium text-sm mb-2">Tips for interpreting your mood trends:</h5>
          <ul class="text-sm text-gray-600 space-y-1 list-disc pl-5">
            <li>Look for seasonal patterns in your moods</li>
            <li>Notice which days of the week tend to have better or worse moods</li>
            <li>Identify potential triggers for mood changes</li>
            <li>Use these insights when planning self-care activities</li>
          </ul>
        </div>
      </div>
    </div>
  }
</div>

<style>
  .mood-point {
    transition: all 0.3s ease-out;
  }

  .mood-point:hover {
    r: 4;
    filter: drop-shadow(0 0 3px rgba(0,0,0,0.3));
  }
</style>
